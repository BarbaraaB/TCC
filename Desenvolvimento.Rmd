#Install Libs
```{r Libs, include=FALSE}
devtools::install_github("hadley/emo")
install.packages("syuzhet")
install.packages("tidyverse")
install.packages("lubridate")
install.packages("wordcloud")
install.packages("tm")
install.packages("devtools")
library(syuzhet)
library(readr)
library(tidyverse)
library(lubridate)
library(wordcloud)
library(tm)
library(emo)

install.packages("wordcloud")
library(wesanderson)
```

```{r Import Tweets, include=FALSE}
#Import entire database of tweets
cleaned_tweets <- read_csv("D:/Faculdade/TCC e IC/cleaned_tweets.csv")

#only part of the base, for testing
cleaned_tweets <- slice_sample(cleaned_tweets, n = 10000, replace = FALSE)

# # of lines
N <- length(cleaned_tweets$created_at)
```

```{r include=FALSE}
#Top emojis used
emojis <- cleaned_tweets %>%
  mutate(emoji = ji_extract_all(cleaned_tweets$full_text)) %>%
  unnest(cols = c(emoji)) %>%
  count(emoji, sort = TRUE) %>%
  top_n(10)
```

```{r Frequency of Words}
# create corpus
corpus = Corpus(VectorSource(cleaned_tweets$full_text))
# create term-document matrix
tdm = TermDocumentMatrix(corpus)
# convert as matrix
tdm = as.matrix(tdm)

m <- as.matrix(tdm)
v <- sort(rowSums(m),decreasing=TRUE)
d <- data.frame(word = names(v),freq=v)
#head(d, 300)
```

```{r Extract Sentiments, include=FALSE}
#extracts the feeling of every word from the tweet from Saif Mohammad's NRC Emotion lexicon
sentiment <- get_nrc_sentiment(cleaned_tweets$full_text, language = "portuguese")
```

```{r formatting dataframe}
#rename columns with portuguese words of sentiments
sentiment <- sentiment %>% 
  rename(
    raiva = anger,
    ansiedade = anticipation,
    nojo = disgust, 
    medo = fear,
    alegria = joy,
    tristeza = sadness, 
    surpresa = surprise, 
    esperanca = trust,
    negativo = negative, 
    positivo = positive
  )

#dataframe of the tweet date + the extraction of emotions
sentiment_dt <- bind_cols(cleaned_tweets[,"created_at"],sentiment)
```

```{r general analysis, include=FALSE}
#transpose sentiment to list the emotions by rows
sentiment_transp<-data.frame(t(sentiment))

#sum total of sentiments
sentiment_sum <- data.frame(sort(rowSums(sentiment_transp),decreasing=TRUE))

#rename column
sentiment_sum <- sentiment_sum %>% 
  rename(
    sum = sort.rowSums.sentiment_transp...decreasing...TRUE.
  )
#add 1 colunm with name of sentiment
sentiment_sum <- cbind("sentiment" = rownames(sentiment_sum), sentiment_sum)

# count of sentiments
count_sentiment <- sentiment_sum[3:10,]

# count of positive and negative
count_pos_neg <- sentiment_sum[1:2,]
```

```{r Just Sentiments per month, include=FALSE}
#Just sentiments
#grouping the months of the dataframe with the sum of emotions divided by month and by emotion
sentiment_month <- sentiment_dt %>% 
  group_by(mes = month(created_at, label = TRUE, abbr = TRUE)) %>% 
  summarise(across(.cols = raiva:esperanca, sum))

#total sum of feelings, divided by month
x <- apply(sentiment_month[,2:9],1,sum)
sentiment_month$total <- x 

#dividing the total by the partials, to find the proportional value of each sentiment
sentiment_month_prop <- sentiment_month %>%
  mutate(across(.cols = raiva:esperanca, ~ round(.x/total*100,2))) 

#drop total column
sentiment_month_prop$total <- NULL
  
#database on longer format for chart
sentiment_month_longer <- pivot_longer(sentiment_month_prop, raiva:esperanca)
```

```{r just pos and neg per month}
#Just positive and negative
#grouping the dataframe months together with the sum of positive and negative
pos_neg_month <- sentiment_dt %>% 
  group_by(mes = month(created_at, label = TRUE, abbr = TRUE)) %>% 
  summarise(across(.cols = negativo:positivo, sum))

#total sum of feelings, divided by month
x <- apply(pos_neg_month[,2:3],1,sum)
pos_neg_month$total <- x 

#dividing the total by the partials, to find the proportional value of each sentiment
pos_neg_month_prop <- pos_neg_month %>%
  mutate(across(.cols = negativo:positivo, ~ round(.x/total*100,2))) 

#drop total column
pos_neg_month_prop$total <- NULL

#database on longer format for chart
pos_neg_month_longer <- pivot_longer(pos_neg_month_prop, negativo:positivo)
```


```{r Graphics}
#line plot sentiment
g <- ggplot(sentiment_month_longer) + 
  aes(x=mes, y=value, color = name, group=name) + 
  geom_line() + 
  geom_point()
g + scale_colour_manual(
    values=c("#120f28","#2e1e5c","#6d4299","#8623ae","#de39e9","#008281","#FF607D","#5E6687"),
    aesthetics = "fill", 
    breaks = waiver())

#line plot positive and negative
ggplot(pos_neg_month_longer) + 
  aes(x=mes, y=value, color = name, group=name) + 
  geom_line(data = subset(pos_neg_month_longer, name =="negativo")) + 
  geom_point(data = subset(pos_neg_month_longer, name =="negativo"))+
  scale_color_brewer(palette = "Dark2") 

ggplot(count_sentiment)+
  aes(x=reorder(sentiment,sum), y=sum, fill = sentiment)+
  coord_flip()+
  geom_col()+
  scale_color_brewer(palette = "Dark2") 

ggplot(count_pos_neg)+
  aes(x="", y=sum, fill = sentiment)+
  geom_bar(width = 1, stat = "identity")+
  coord_polar("y", start=0)+
  scale_fill_manual(values=c("#120f28","#6d4299"))

ggplot(emojis)+
  aes(x=reorder(emoji,-n), y=n, fill = emoji)+
  geom_col()+
  theme(legend.text=element_text(size=20))+
  scale_color_brewer(palette = "Dark2") 

ggplot(emojis)+
  aes(x=reorder(emoji,-n), y=n, fill = emoji)+
  geom

#Word cloud 
wordcloud(words = d$word, freq = d$freq, max.words = 200, random.order = FALSE, color=brewer.pal(8,"Dark2"))

#ggsave("D:/Faculdade/TCC e IC/Imagens/grafico_dispers.png", g)
```

